<script>
  // Charger le CSV
  fetch('data/resultats_csv.csv')
    .then(r => r.text())
    .then(text => {
      const lines = text.replace(/\r/g,'').split('\n');
      const headers = lines[0].split(';').map(h => h.trim());
      const data = lines.slice(1).filter(l => l.trim() !== '').map(l => l.split(';').map(c => c.trim()));

      // ---- TABLEAU GENERAL ----
      let tableHTML = '<table id="resultsTable" class="csv-table"><thead><tr>';
      headers.forEach((h, i) => {
        const uniqueValues = [...new Set(data.map(row => row[i]))].sort();
        let selectHTML = `<select class="colFilter" data-col="${i}"><option value="">Tous</option>`;
        uniqueValues.forEach(val => { selectHTML += `<option value="${val}">${val}</option>`; });
        selectHTML += '</select>';
        tableHTML += `<th>${h}<br>${selectHTML}</th>`;
      });
      tableHTML += '</tr></thead><tbody>';

      data.forEach(row => {
        tableHTML += '<tr>';
        row.forEach(cell => tableHTML += `<td>${cell}</td>`);
        tableHTML += '</tr>';
      });

      tableHTML += '</tbody></table>';
      document.getElementById('tableContainer').innerHTML = tableHTML;

      // ---- RECORDS ----
      function parseTime(t) {
        // Convertir "mm:ss.xx" ou "hh:mm:ss.xx" en secondes pour comparer
        const parts = t.split(':');
        let sec = 0;
        if (parts.length === 2) { // mm:ss.xx
          sec = parseFloat(parts[0]) * 60 + parseFloat(parts[1]);
        } else if (parts.length === 3) { // hh:mm:ss.xx
          sec = parseFloat(parts[0]) * 3600 + parseFloat(parts[1]) * 60 + parseFloat(parts[2]);
        } else {
          sec = parseFloat(t) || Infinity;
        }
        return sec;
      }

      function computeRecords(sex) {
        let records = {};
        data.forEach(row => {
          const epreuve   = row[0]; // épreuve
          const sexe      = row[2]; // sexe
          const nom       = row[3]; // nageur
          const temps     = row[5]; // temps
          const categorie = row[8]; // catégorie

          if (sexe !== sex) return;

          if (!records[epreuve]) records[epreuve] = {};
          if (!records[epreuve][categorie] || parseTime(records[epreuve][categorie].temps) > parseTime(temps)) {
            records[epreuve][categorie] = { nom, temps };
          }
        });
        return records;
      }

      function recordsToHTML(records) {
        // Extraire toutes les catégories existantes
        const categories = new Set();
        Object.values(records).forEach(cats => {
          Object.keys(cats).forEach(c => categories.add(c));
        });
        const cats = Array.from(categories).sort();

        let html = '<table class="csv-table"><thead><tr><th>Épreuve</th>';
        cats.forEach(c => html += `<th>${c}</th>`);
        html += '</tr></thead><tbody>';

        Object.keys(records).forEach(epreuve => {
          html += `<tr><td>${epreuve}</td>`;
          cats.forEach(c => {
            if (records[epreuve][c]) {
              html += `<td>${records[epreuve][c].temps}<br><small>${records[epreuve][c].nom}</small></td>`;
            } else {
              html += '<td>-</td>';
            }
          });
          html += '</tr>';
        });

        html += '</tbody></table>';
        return html;
      }

      const recordsFemmes = computeRecords("Feminin");
      const recordsHommes = computeRecords("Masculin");

      document.getElementById('recordsFemmes').innerHTML = recordsToHTML(recordsFemmes);
      document.getElementById('recordsHommes').innerHTML = recordsToHTML(recordsHommes);

      // ---- FILTRES ----
      const filters = document.querySelectorAll('.colFilter');
      filters.forEach(select => {
        select.addEventListener('change', () => {
          const rows = document.querySelectorAll('#resultsTable tbody tr');
          rows.forEach(row => {
            let show = true;
            filters.forEach(f => {
              const col = f.dataset.col;
              const val = f.value;
              if (val && row.cells[col].textContent !== val) show = false;
            });
            row.style.display = show ? '' : 'none';
          });
        });
      });
    })
    .catch(err => {
      console.error(err);
      document.getElementById('tableContainer').textContent = 'Erreur lors du chargement des résultats.';
    });
</script>

