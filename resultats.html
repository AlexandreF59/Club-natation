<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Résultats - Hauts de Flandre Natation</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .csv-table {
      border-collapse: collapse;
      width: 90%;
      max-width: 1200px;
      margin: 1.5em auto;
      background-color: #f9f9f9;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .csv-table th, .csv-table td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: center;
    }
    .csv-table th {
      background-color: #0057b8;
      color: white;
    }
    .csv-table tr:nth-child(even) { background-color: #e6f0fa; }
    .csv-table tr:hover { background-color: #d0e4ff; }
    h2 { text-align: center; margin-top: 1.5em; }
    .small { font-size: 0.85em; color: #333; }
    .no-records { text-align:center; color:#666; margin:0.8em 0 1.5em 0; }
  </style>
</head>
<body>
  <div id="header"></div>

  <main>
    <section class="intro-section">
      <h2>Résultats du club</h2>
      <p>
        Retrouvez ici les performances de nos nageurs, extraites des résultats officiels de la
        <a href="https://www.ffnatation.fr" target="_blank"><strong>Fédération Française de Natation (FFN)</strong></a>.
      </p>
    </section>

    <h2>Records Féminins</h2>
    <div id="recordsFemmes">Chargement...</div>

    <h2>Records Masculins</h2>
    <div id="recordsHommes">Chargement...</div>

    <h2>Tous les résultats</h2>
    <div id="tableContainer">Chargement des résultats...</div>
  </main>

  <footer id="footer"></footer>

  <script data-goatcounter="https://clubhautsdeflandrenatation.goatcounter.com/count"
          async src="https://gc.zgo.at/count.js"></script>

  <script>
  // --- utilitaires
  function normalizeText(s) {
    return String(s||'').trim().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  }
  function normalizeSex(s) {
    const n = normalizeText(s);
    if (n.includes('fem')) return 'Feminin';
    if (n.includes('masc') || n.includes('hom')) return 'Masculin';
    return '';
  }
  function parseTimeToSeconds(t) {
    if (!t) return Infinity;
    const s = t.trim().replace(',', '.');
    const parts = s.split(':').map(x => parseFloat(x));
    if (parts.some(isNaN)) return Infinity;
    if (parts.length === 1) return parts[0];
    if (parts.length === 2) return parts[0]*60 + parts[1];
    if (parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
    return Infinity;
  }

  // ordre de colonnes souhaité
  const categoryOrder = [
    "Avenirs", "Benjamins", "Juniors", "Seniors",
    "Master C1", "Master C2", "Master C3", "Master C4",
    "Master C5", "Master C6", "Master C7", "Master C8", "Master C9"
  ];

  function orderCategories(allCats, records, epreuves) {
    // garder uniquement celles qui ont au moins un résultat
    const catsWithRecords = allCats.filter(cat => {
      return epreuves.some(ep => records[ep] && records[ep][cat]);
    });
    // ordonner selon liste de référence puis rajouter les autres
    const ordered = categoryOrder.filter(c => catsWithRecords.includes(c));
    const extras = catsWithRecords.filter(c => !categoryOrder.includes(c)).sort();
    return [...ordered, ...extras];
  }

  // --- charger header/footer
  fetch('header.html').then(r=>r.text()).then(d=>document.getElementById('header').innerHTML=d);
  fetch('footer.html').then(r=>r.text()).then(d=>document.getElementById('footer').innerHTML=d);

  // --- charger CSV
  fetch('data/resultats_csv.csv')
    .then(r => r.text())
    .then(text => {
      const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim()!=='');
      const headers = lines[0].split(';').map(h=>h.trim());
      const data = lines.slice(1).map(l => l.split(';').map(c=>c.trim()));

      // indices selon ton CSV
      const IDX_EPREUVE = 0;
      const IDX_SEXE = 2;
      const IDX_NOM = 3;
      const IDX_TEMPS = 5;
      const IDX_CATEG = 8;

      // tableau complet
      let tableHTML = '<table id="resultsTable" class="csv-table"><thead><tr>';
      headers.forEach((h,i) => tableHTML += `<th>${h}</th>`);
      tableHTML += '</tr></thead><tbody>';
      data.forEach(row => {
        tableHTML += '<tr>' + row.map(c=>`<td>${c}</td>`).join('') + '</tr>';
      });
      tableHTML += '</tbody></table>';
      document.getElementById('tableContainer').innerHTML = tableHTML;

      // listes globales
      const epreuves = [...new Set(data.map(r => r[IDX_EPREUVE]))].filter(Boolean).sort();
      const categories = [...new Set(data.map(r => r[IDX_CATEG]))].filter(Boolean);

      function computeRecordsForSex(sexWanted) {
        const records = {};
        epreuves.forEach(ep => records[ep] = {});
        data.forEach(r => {
          const ep = r[IDX_EPREUVE];
          const sex = normalizeSex(r[IDX_SEXE]);
          if (sex !== sexWanted) return;
          const nom = r[IDX_NOM];
          const t = r[IDX_TEMPS];
          const cat = r[IDX_CATEG];
          const sec = parseTimeToSeconds(t);
          if (!records[ep][cat] || records[ep][cat].sec > sec) {
            records[ep][cat] = {nom, temps:t, sec};
          }
        });
        return records;
      }

      function makeRecordsTable(records) {
        const cats = orderCategories(categories, records, epreuves);
        if (!cats.length) return '<p class="no-records">Aucun record trouvé</p>';
        let html = '<table class="csv-table"><thead><tr><th>Épreuve</th>';
        cats.forEach(c => html += `<th>${c}</th>`);
        html += '</tr></thead><tbody>';
        epreuves.forEach(ep => {
          html += `<tr><td style="text-align:left">${ep}</td>`;
          cats.forEach(c => {
            const rec = records[ep][c];
            html += rec ? `<td>${rec.temps}<br><small class="small">${rec.nom}</small></td>` : '<td>—</td>';
          });
          html += '</tr>';
        });
        html += '</tbody></table>';
        return html;
      }

      document.getElementById('recordsFemmes').innerHTML = makeRecordsTable(computeRecordsForSex('Feminin'));
      document.getElementById('recordsHommes').innerHTML = makeRecordsTable(computeRecordsForSex('Masculin'));
    })
    .catch(err => {
      console.error(err);
      document.getElementById('tableContainer').textContent = 'Erreur lors du chargement.';
    });
  </script>
</body>
</html>
